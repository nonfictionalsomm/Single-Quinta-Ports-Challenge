<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quinta-Producer Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #FDF8F2; /* Creamy background */
            color: #4B3F3F; /* Dark brown text */
        }
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        .game-card {
            background-color: #FFFFFF;
            border: 1px solid #DED1C1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-choice {
            transition: all 0.2s ease-in-out;
            border: 2px solid #DED1C1;
            background-color: #fff;
        }
        .btn-choice:hover:not(:disabled) {
            background-color: #FDF8F2;
            transform: translateY(-2px);
        }
        .btn-choice.correct {
            background-color: #D1FAE5; /* Green for correct */
            border-color: #6EE7B7;
            color: #065F46;
            cursor: not-allowed;
        }
        .btn-choice.incorrect {
            animation: shake 0.5s;
            background-color: #FEE2E2; /* Red for incorrect */
            border-color: #FCA5A5;
            cursor: not-allowed;
        }
        .btn-primary {
             background-color: #8C1C13; /* Adapted red-800 */
             color: white;
        }
        .btn-primary:hover {
            background-color: #6D160E; /* Adapted red-900 */
        }
        .btn-secondary {
            background-color: #DED1C1;
            color: #4B3F3F;
        }
        .btn-secondary:hover {
            background-color: #C9BBAA;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Start Game Modal -->
    <div id="start-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center transform transition-all">
            <h2 class="text-4xl font-bold mb-4" style="color: #8C1C13;">Welcome!</h2>
            <p class="text-lg mb-6 text-left text-gray-700">Test your knowledge of Single Quinta Vintage Ports.</p>
            <div class="text-left space-y-3 mb-8 bg-red-800/5 p-4 rounded-lg border border-red-800/10">
                <p><strong style="color: #8C1C13;">GOAL:</strong> Match the Quinta with its correct Producer.</p>
                <p><strong style="color: #8C1C13;">SCORING:</strong></p>
                <ul class="list-disc list-inside pl-4 text-gray-600">
                    <li><span class="font-bold text-green-700">+2 points</span> for a correct match on the first try.</li>
                    <li><span class="font-bold text-green-700">+1 point</span> for a correct match on subsequent tries.</li>
                    <li><span class="font-bold text-red-700">-1 point</span> for an incorrect match.</li>
                </ul>
                <p class="mt-2 text-gray-600">You get unlimited guesses, but be careful with your score!</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="start-game-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors text-xl">Start Challenge</button>
                <button id="study-db-btn" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg transition-colors text-xl">Study Database</button>
            </div>
        </div>
    </div>

    <!-- Database View -->
    <div id="database-view" class="w-full max-w-4xl mx-auto hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold" style="color: #8C1C13;">Quinta Database</h1>
            <button id="back-to-menu-btn" class="btn-secondary font-bold py-2 px-6 rounded-lg transition-colors text-lg">&larr; Back</button>
        </div>
        <div class="game-card rounded-lg p-6 md:p-8 max-h-[70vh] overflow-y-auto">
             <div id="database-list" class="space-y-5">
                <!-- DB items will be injected here -->
             </div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="w-full max-w-4xl mx-auto hidden">
        <div class="flex justify-between items-center mb-6">
             <h1 class="text-4xl md:text-5xl font-bold" style="color: #8C1C13;">Port Master</h1>
             <button id="game-back-to-menu-btn" class="btn-secondary font-bold py-2 px-6 rounded-lg transition-colors text-lg">&larr; Main Menu</button>
        </div>

        <!-- Score and Round Info -->
        <div class="flex justify-between items-center mb-6 p-4 rounded-lg bg-red-800/10 game-card" style="color: #8C1C13;">
            <div class="text-center">
                <h3 class="text-xl font-bold">Round</h3>
                <p id="round-info" class="text-2xl font-semibold">1 / 10</p>
            </div>
            <div class="text-center">
                <h3 class="text-xl font-bold">Score</h3>
                <p id="score-info" class="text-2xl font-semibold">0</p>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="game-card rounded-lg p-6 md:p-8">
            <div class="text-center mb-6">
                <p class="text-lg mb-2">Match the Quinta:</p>
                <h2 id="quinta-prompt" class="text-3xl md:text-4xl font-bold">Quinta Name Here</h2>
            </div>

            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Producer buttons will be inserted here -->
            </div>

            <div id="feedback-message" class="text-center mt-6 h-6 text-xl font-semibold">
                <!-- Feedback like "Correct!" or "Try again!" -->
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full transform transition-all scale-95 opacity-0">
            <h2 class="text-4xl font-bold mb-6 text-center text-green-700">Correct!</h2>
            
            <div class="text-left space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div>
                    <h3 class="text-xl font-bold" style="color: #8C1C13;" id="success-producer">Producer Name, est. XXXX</h3>
                    <p class="text-lg font-semibold text-gray-800 mt-1" id="success-quinta">Quinta Name Here</p>
                </div>
                <div>
                    <h4 class="text-md font-bold text-gray-500 uppercase tracking-wider">Notes</h4>
                    <p class="text-base text-gray-700 mt-1" id="success-notes">Notes will go here...</p>
                </div>
            </div>

            <button id="next-round-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors mt-8 text-lg">Next Round</button>
        </div>
    </div>
    
    <!-- Game Over Modal -->
    <div id="game-over-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-4xl font-bold mb-4" style="color: #8C1C13;">Challenge Complete!</h2>
            <p id="final-score-message" class="text-3xl font-bold mb-4" style="color: #8C1C13;"></p>
            <div class="bg-red-800/10 p-4 rounded-lg mb-6">
                <p class="text-lg text-left clear-both">Final Score: <span id="final-score" class="font-bold float-right">0</span></p>
                <p class="text-lg text-left mt-1 clear-both">Percentage: <span id="final-percentage" class="font-bold float-right">0%</span></p>
            </div>
            <button id="play-again-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors">Play Again</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        // This is the full database, used for the "Study" and "Success" modals
        const DB_DATA = [
            { "Producer": "BURMESTER, est. 1730", "Quinta": "Quinta do Nova de Nossa Senhora do Carmo (Cima Corgo)", "Notes": "(Sogevinus)\nPurchased by Burmester in 1991 from Royal Oporto/Real Companhia Velha. SQVP was made as a separate label.\nAlso produces Quinta do Arnozelo (see Calem), which is a quinta under their parent company, Sogevinus." },
            { "Producer": "CALEM, est 1859", "Quinta": "Quinta da Foz (Cima Corgo)", "Notes": "(Sogevinus)\nOwned by Calem since 1885. SQVP first produced from the quinta in 1982." },
            { "Producer": "CALEM, est 1859", "Quinta": "Quinta do Sagrado", "Notes": "(Sogevinus)" },
            { "Producer": "CALEM, est 1859", "Quinta": "Quinta do Arnozelo (Douro Superior)", "Notes": "(Sogevinus)\nTo be produced in future bottlings." },
            { "Producer": "CHAMPALIMAUD", "Quinta": "Quinta do Cotto (Baixo Corgo)", "Notes": "" },
            { "Producer": "CHURCHILL'S, est. 1981", "Quinta": "Quinta do Agua Alta (Cima Corgo)", "Notes": "The quinta historically supplied grapes to Cockburn's and Taylor's." },
            { "Producer": "CHURCHILL'S, est. 1981", "Quinta": "Quinta do Gricha (Cima Corgo)", "Notes": "Acquired in 1999." },
            { "Producer": "COCKBURN'S, est. 1815", "Quinta": "Quinta dos Canais (Douro Superior)", "Notes": "(Symington)" },
            { "Producer": "COCKBURN'S, est. 1815", "Quinta": "Quinta do Tua (Cima Corgo)", "Notes": "(Symington)\nOwned from 1889-2006, Sold to Graham's in 2006. In 1973, it absorbed Quinta da Chousa, an adjacent property owned by Symington." },
            { "Producer": "CROFT, est. 1736", "Quinta": "Quinta do Roêda (Cima Corgo)", "Notes": "(Fladgate's)\nSQVP produced since 1978." },
            { "Producer": "DELAFORCE, est. 1868", "Quinta": "Quinta da Corte (Cima Corgo)", "Notes": "(Real Companhia aka Royal Oporto)" },
            { "Producer": "DOW'S, est. 1877", "Quinta": "Quinta do Bomfim (Cima Corgo)", "Notes": "(Symington)\nSQVPs since 1978" },
            { "Producer": "DOW'S, est. 1877", "Quinta": "Quinta Senhora da Ribeira (Douro Superior)", "Notes": "(Symington)" },
            { "Producer": "FERREIRA, est. 1751", "Quinta": "Quinta do Porto (Cima Corgo)", "Notes": "(Sogrape)\nGrapes used for Ferreira's Single Quinta 10 Year Tawny Port" },
            { "Producer": "FERREIRA, est. 1751", "Quinta": "Quinta do Seixo (Cima Corgo)", "Notes": "(Sogrape)\nAcquired in 1979, SQVP first produced in 1983." },
            { "Producer": "FONSECA, est. 1815", "Quinta": "Quinta do Panascal (Cima Corgo)", "Notes": "(Fladgate's)\nAcquired in 1978" },
            { "Producer": "GRAHAM'S, est. 1820", "Quinta": "Quinta dos Malvedos (Cima Corgo)", "Notes": "(Symington)\nProduced as an SQVP beginning 1998" },
            { "Producer": "GRAHAM'S, est. 1820", "Quinta": "Quinta do Tua (Cima Corgo)", "Notes": "(Symington)\nOwned by Ferreira, then Cockburn's, then acquired by Graham's in 2006. Presently, no SQVP by Graham's has been produced. (See Cockburn's)\nAlso owns Quinta da Vila Velha, Quinta do Vale de Malhadas, and Quinta das Lages. The three vineyards, as well as Quinta do Tua (as of yet), do not produce SQVP." },
            { "Producer": "KOPKE, est. 1638", "Quinta": "Quinta do São Luiz (Cima Corgo)", "Notes": "(Sogevinus)\nAcquired in 1922; Kopke Vintage Ports use grapes primarily from this quinta." },
            { "Producer": "MARTINEZ, est. 1790", "Quinta": "Quinta do Chousa", "Notes": "(Symington)\nAbsorbed by Quinta do Tua, an adjacent quinta, owned by the Symington Family." },
            { "Producer": "MARTINEZ, est. 1790", "Quinta": "Quinta da Eira Velha (Cima Corgo)", "Notes": "(Symington)\nOne of the oldest vineyards in the Duoro Valley, dating back to 1513. Historically used by Graham’s, Ferreira, and Cockburn’s before being shipped under the Martinez label in 1987. Sold in 2007 to Fladgate’s." },
            { "Producer": "MESSIAS, est. 1926", "Quinta": "Quinta do Cachão (Cima Corgo)", "Notes": "Acquired in 1956." },
            { "Producer": "NIEPOORT, est. 1842", "Quinta": "Quinta do Passadouro", "Notes": "Quinta do Passadouro was acquired in 1991 by Niepoort, but since 2004, the Quinta has been independently produced. Then it was sold to AXA Millésimes and moved to the Quinta de Noval label in 2019." },
            { "Producer": "DE ROMANIERA, est. 1854", "Quinta": "Quinta das Liceiras (Cima Corgo)", "Notes": "(IDI)" },
            { "Producer": "QUINTA DO VESUVIO", "Quinta": "Quinta do Vesuvio", "Notes": "(Symington)\nQuinta do Vesuvio is the SQVP.\nVesuvio A Capela: A limited production, premium Vintage Port Bottling produced in 2007, 2011, 2016, and 2017.\n(Douro Superior)\nAcquired in 1987 by the Symington Family. Originally owned by the Ferreira Family." },
            { "Producer": "QUINTA DO NOVAL, est. 1715", "Quinta": "Quinta do Silval (Cima Corgo)", "Notes": "(AXA Millesimes)\n(Last vintage 2015)" },
            { "Producer": "QUINTA DO NOVAL, est. 1715", "Quinta": "Quinta do Passadouro (Cima Corgo)", "Notes": "(AXA Millesimes)\n(First vintage 2019)" },
            { "Producer": "QUINTA DO NOVAL, est. 1715", "Quinta": "Quinta do Noval (Cima Corgo)", "Notes": "(AXA Millesimes)\nProperties made from grapes from various vineyards are labeled as “Noval.” Ports made from only “Quinta do Noval” are labeled as such." },
            { "Producer": "QUINTA DO NOVAL, est. 1715", "Quinta": "Quinta do Noval Nacional (Cima Corgo)", "Notes": "(AXA Millesimes)\nNot a separate vineyard, but the heart of Quinta do Noval vineyard. Post-phylloxera, ungrafted vines." },
            { "Producer": "RAMOS PINTO, est. 1880", "Quinta": "Quinta do Bom Retiro (Cima Corgo)", "Notes": "(Roederer Group)\nUsed for 20 Year Tawny Ports\n*Quinta do Urtiga and Quinta de Bons Ares are also properties of Ramos Pinto, but are not used for SQVP bottlings." },
            { "Producer": "RAMOS PINTO, est. 1880", "Quinta": "Quinta do Ervamoira (Douro Superior)", "Notes": "(Roederer Group)\nUsed for SQVP as well as 10 Year Tawny Port Label.\nFormerly known as 'Quinta de Santa Maria. Entirely mechanized vineyard." },
            { "Producer": "SANDEMAN, est. 1790", "Quinta": "Quinta do Vau (Cima Corgo)", "Notes": "(Sogrape)\nAcquired in 1988." },
            { "Producer": "SANDEMAN, est. 1790", "Quinta": "Quinta do Seixo (Cima Corgo)", "Notes": "(Sogrape)\nSeixo, owned by Sogrape, was transferred to Sandeman in 2002, 2013 was first Sandeman QdSeixo." },
            { "Producer": "SMITH WOODHOUSE, est. 1784", "Quinta": "Quinta da Madalena (Cima Corgo)", "Notes": "(Symington)" },
            { "Producer": "TAYLOR-FLADGATE, est. 1692", "Quinta": "Quinta de Vargellas (Douro Superior)", "Notes": "(aka Taylor's)\nIn 1995, Vargellas Vinha Velha was produced from small old vine plots.\nPrimary vineyard used for Vintage Port Bottlings. First SQVP 1958 (and the first SQVP bottling marketed as such)." },
            { "Producer": "TAYLOR-FLADGATE, est. 1692", "Quinta": "Quinta de Terra Feita (Cima Corgo)", "Notes": "(aka Taylor's)\nFirst SQVP in 1986. Used for Vintage Port Bottlings." },
            { "Producer": "TAYLOR-FLADGATE, est. 1692", "Quinta": "Quinta do Junco (Cima Corgo)", "Notes": "(aka Taylor's)\nRecent acquisition, currently being used for Vintage Port bottlings." },
            { "Producer": "VAN ZELLER, est. 1780", "Quinta": "Quinta do Roriz (Cima Corgo)", "Notes": "Produced from 1999-2009, but now currently owned by the Symington Family." },
            { "Producer": "VAN ZELLER, est. 1780", "Quinta": "Quinta do Vale de Dona Maria (Cima Corgo)", "Notes": "Purchased in 1995. Producing Vintage Port and Duoro Tinto DOP wines." },
            { "Producer": "WARRE’S, est. 1670", "Quinta": "Quinta da Cavadinha (Cima Corgo)", "Notes": "(Symington)\nQuinta do Retiro Antigo, de Telhada, and do Alvito are also owned by Warre’s for their port range." },
            { "Producer": "WIESE & KROHN, est. 1865", "Quinta": "Quinta do Retiro Novo (Cima Corgo)", "Notes": "(Fladgate)\nAcquired by Taylor-Fladgate in June 2013." }
        ];

        // --- PRE-PROCESS DATA ---
        // Helper function to clean producer name for matching
        const cleanProducer = (name) => name.split(',')[0].trim();
        // Helper function to clean quinta name for matching
        const cleanQuinta = (name) => name.split('(')[0].trim();

        // This is the clean data used for the game logic
        const GAME_DATA = DB_DATA.map(item => ({
            producer: cleanProducer(item.Producer),
            quinta: cleanQuinta(item.Quinta)
        })).filter(item => item.quinta && item.producer); // Ensure no empty entries

        // A unique list of all producer names for generating wrong answers
        const ALL_PRODUCERS = [...new Set(GAME_DATA.map(item => item.producer))];

        const TOTAL_ROUNDS = 10;
        const MAX_SCORE = TOTAL_ROUNDS * 2; // +2 for first try

        // --- GAME STATE ---
        let score = 0;
        let currentRound = 1;
        let gameQuestions = [];
        let firstTry = true;
        let blockGuess = false;

        // --- DOM ELEMENTS ---
        const startModal = document.getElementById('start-modal');
        const databaseView = document.getElementById('database-view');
        const gameContainer = document.getElementById('game-container');
        const successModal = document.getElementById('success-modal');
        const gameOverModal = document.getElementById('game-over-modal');
        
        const startGameBtn = document.getElementById('start-game-btn');
        const studyDbBtn = document.getElementById('study-db-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const gameBackToMenuBtn = document.getElementById('game-back-to-menu-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const playAgainBtn = document.getElementById('play-again-btn');

        const databaseList = document.getElementById('database-list');
        const scoreInfo = document.getElementById('score-info');
        const roundInfo = document.getElementById('round-info');
        const quintaPrompt = document.getElementById('quinta-prompt');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        
        // Success Modal Content
        const successProducer = document.getElementById('success-producer');
        const successQuinta = document.getElementById('success-quinta');
        const successNotes = document.getElementById('success-notes');

        // Game Over Modal Content
        const finalScore = document.getElementById('final-score');
        const finalPercentage = document.getElementById('final-percentage');
        const finalScoreMessage = document.getElementById('final-score-message');

        // --- FUNCTIONS ---

        /**
         * Shuffles an array in place.
         * @param {Array} array The array to shuffle.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Initializes the game or starts a new one.
         */
        function initGame() {
            score = 0;
            currentRound = 1;
            gameQuestions = shuffleArray([...GAME_DATA]).slice(0, TOTAL_ROUNDS);
            startRound();
        }
        
        /**
         * Starts a new round.
         */
        function startRound() {
            if (currentRound > TOTAL_ROUNDS) {
                showGameOver();
                return;
            }

            // Reset round state
            firstTry = true;
            blockGuess = false;
            feedbackMessage.textContent = '';
            
            const currentQuestion = gameQuestions[currentRound - 1];

            quintaPrompt.textContent = currentQuestion.quinta;
            updateScoreboard();
            renderButtons(currentQuestion);
        }

        /**
         * Renders the choice buttons for producers.
         */
        function renderButtons(currentQuestion) {
            optionsContainer.innerHTML = '';
            
            const correctProducer = currentQuestion.producer;
            let options = [correctProducer];
            
            // Get 3 random wrong producers
            const wrongProducers = shuffleArray(ALL_PRODUCERS.filter(p => p !== correctProducer));
            options.push(...wrongProducers.slice(0, 3));

            // Shuffle and display options
            shuffleArray(options).forEach(producer => {
                const button = document.createElement('button');
                button.textContent = producer;
                button.classList.add('btn-choice', 'w-full', 'text-left', 'p-4', 'rounded-lg', 'font-semibold');
                button.onclick = () => handleGuess(button, correctProducer);
                optionsContainer.appendChild(button);
            });
        }
        
        /**
         * Handles the player's selection of a producer.
         */
        function handleGuess(button, correctProducer) {
            if (blockGuess) return; // Prevent multiple clicks

            const selectedProducer = button.textContent;

            if (selectedProducer === correctProducer) {
                // --- CORRECT GUESS ---
                blockGuess = true;
                button.classList.add('correct');
                feedbackMessage.textContent = 'Correct!';
                feedbackMessage.style.color = '#065F46'; // Green

                if (firstTry) {
                    score += 2;
                } else {
                    score += 1;
                }
                
                // Disable all buttons
                Array.from(optionsContainer.children).forEach(btn => {
                    btn.disabled = true;
                    if (!btn.classList.contains('correct')) {
                        btn.style.opacity = '0.6';
                    }
                });

                updateScoreboard();
                
                // Find full data and show success modal
                const currentQuestion = gameQuestions[currentRound - 1];
                const fullData = findFullData(currentQuestion);
                populateSuccessModal(fullData);
                setTimeout(showSuccessModal, 500); // Wait 0.5s before showing modal

            } else {
                // --- INCORRECT GUESS ---
                button.classList.add('incorrect');
                button.disabled = true; // Disable this wrong option
                feedbackMessage.textContent = 'Try again!';
                feedbackMessage.style.color = '#DC2626'; // Red
                
                score = Math.max(0, score - 1);
                firstTry = false;
                updateScoreboard();

                // Remove shake class
                setTimeout(() => {
                    button.classList.remove('incorrect');
                }, 500);
            }
        }

        /**
         * Finds the full DB_DATA entry based on the clean GAME_DATA object.
         */
        function findFullData(gameQuestion) {
            return DB_DATA.find(item => 
                cleanProducer(item.Producer) === gameQuestion.producer &&
                cleanQuinta(item.Quinta) === gameQuestion.quinta
            ) || { Producer: "Error", Quinta: "Error", Notes: "Could not find data." };
        }

        /**
         * Populates the Success Modal with the full data.
         */
        function populateSuccessModal(fullData) {
            successProducer.textContent = fullData.Producer;
            successQuinta.textContent = fullData.Quinta;
            successNotes.innerHTML = fullData.Notes.replace(/\n/g, '<br>') || "<em>No notes available.</em>";
        }

        /**
         * Shows the success modal.
         */
        function showSuccessModal() {
            successModal.classList.remove('hidden');
            setTimeout(() => {
                successModal.firstElementChild.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        /**
         * Hides the success modal and starts the next round.
         */
        function hideSuccessModal() {
            successModal.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                successModal.classList.add('hidden');
                currentRound++;
                startRound();
            }, 200);
        }

        /**
         * Updates the score and round display.
         */
        function updateScoreboard() {
            scoreInfo.textContent = score;
            roundInfo.textContent = `${Math.min(currentRound, TOTAL_ROUNDS)} / ${TOTAL_ROUNDS}`;
        }

        /**
         * Populates and shows the database view.
         */
        function showDatabase() {
            databaseList.innerHTML = ''; // Clear old list

            DB_DATA.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'border-b border-gray-200 pb-4';
                
                // Format notes to preserve line breaks
                const formattedNotes = item.Notes.replace(/\n/g, '<br>') || "<em>No notes available.</em>";

                itemEl.innerHTML = `
                    <h3 class="text-xl font-bold" style="color: #8C1C13;">${item.Producer}</h3>
                    <p class="text-lg font-semibold text-gray-800 mt-1">${item.Quinta}</p>
                    <p class="text-base text-gray-600 mt-2">${formattedNotes}</p>
                `;
                databaseList.appendChild(itemEl);
            });
            
            startModal.classList.add('hidden');
            databaseView.classList.remove('hidden');
        }

        /**
         * Hides the database and shows the start modal.
         */
        function hideDatabase() {
            databaseView.classList.add('hidden');
            startModal.classList.remove('hidden');
        }

        /**
         * Shows the game over screen with a final score, percentage, and message.
         */
        function showGameOver() {
            // Calculate percentage, ensuring it's not below 0.
            const percentage = Math.round(Math.max(0, (score / MAX_SCORE) * 100));

            let message = '';
            if (percentage === 100) {
                message = "Perfect Score!";
            } else if (percentage >= 90) {
                message = "You're a Port Master!";
            } else if (percentage >= 75) {
                message = "Excellent Work!";
            } else if (percentage >= 50) {
                message = "Good job!";
            } else {
                message = "Keep studying!";
            }

            finalScore.textContent = score;
            finalPercentage.textContent = `${percentage}%`;
            finalScoreMessage.textContent = message;
            
            gameContainer.classList.add('hidden');
            gameOverModal.classList.remove('hidden');
            setTimeout(() => {
                gameOverModal.firstElementChild.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        /**
         * Hides the game over screen and returns to the start modal.
         */
        function hideGameOver() {
            gameOverModal.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                gameOverModal.classList.add('hidden');
                startModal.classList.remove('hidden');
            }, 200);
        }

        // --- EVENT LISTENERS ---
        startGameBtn.addEventListener('click', () => {
            startModal.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            initGame();
        });
        
        studyDbBtn.addEventListener('click', showDatabase);
        backToMenuBtn.addEventListener('click', hideDatabase);
        
        gameBackToMenuBtn.addEventListener('click', () => {
            gameContainer.classList.add('hidden');
            startModal.classList.remove('hidden');
        });

        nextRoundBtn.addEventListener('click', hideSuccessModal);
        playAgainBtn.addEventListener('click', hideGameOver);

    </script>
</body>
</html>
